<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Presenter Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@0.378.0/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

    <style>
        /* Font Import */
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

        /* Cyberpunk Theme Variables */
        :root {
            --bg-deep-charcoal: #1a1a1d;
            --bg-midnight-blue: #0f0f2e;
            --text-electric-blue: #61dafb;
            --text-neon-green: #39ff14;
            --accent-hot-pink: #ff00ff;
            --accent-cyber-yellow: #f7ff00;
            --accent-glitch-purple: #9400d3;
            --border-color: #61dafb4d; /* Electric blue with transparency */
        }

        body {
            font-family: 'Share Tech Mono', monospace;
            background-color: var(--bg-deep-charcoal);
            color: var(--text-electric-blue);
            overscroll-behavior: none;
        }

        /* Neon Glow Effect */
        .neon-text {
            text-shadow: 0 0 2px #fff, 0 0 4px currentColor, 0 0 8px currentColor;
        }
        
        .neon-text-green {
            color: var(--text-neon-green);
            text-shadow: 0 0 2px #fff, 0 0 5px var(--text-neon-green), 0 0 10px var(--text-neon-green);
        }

        .neon-text-pink {
            color: var(--accent-hot-pink);
            text-shadow: 0 0 2px #fff, 0 0 5px var(--accent-hot-pink), 0 0 10px var(--accent-hot-pink);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: var(--bg-deep-charcoal); }
        ::-webkit-scrollbar-thumb { background-color: var(--accent-hot-pink); border-radius: 5px; border: 2px solid var(--bg-deep-charcoal); }
        ::-webkit-scrollbar-thumb:hover { background-color: var(--text-electric-blue); }

        /* Animation for floating emoji reactions */
        @keyframes float-up {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-300px) scale(1.5); opacity: 0; }
        }
        .reaction-emoji {
            position: absolute;
            bottom: 20px;
            font-size: 2rem;
            animation: float-up 3s ease-out forwards;
            pointer-events: none;
            text-shadow: 0 0 5px #fff;
        }

        /* Presenter notes styling */
        .presenter-notes {
            transition: height 0.3s ease-in-out;
        }
        
        /* QR code container styling */
        #qrcode-container {
            border: 2px solid var(--accent-glitch-purple);
            border-radius: 8px;
            background: white; /* QR codes need a light background to be scannable */
        }
        #qrcode-container img {
            margin: auto;
        }

        /* Timer animation */
        @keyframes flash-pink-glow {
            0%, 100% { background-color: var(--accent-hot-pink); box-shadow: 0 0 20px var(--accent-hot-pink); }
            50% { background-color: #c700c7; box-shadow: 0 0 35px var(--accent-hot-pink); }
        }
        .timer-finished {
            animation: flash-pink-glow 1s infinite;
        }

    </style>
</head>
<body class="bg-deep-charcoal text-electric-blue">

    <div id="app-container" class="flex h-screen w-screen">
    </div>

    <div id="modal-container" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
        <div id="modal-content" class="bg-midnight-blue rounded-lg shadow-lg p-6 w-full max-w-md border-2 border-hot-pink" style="--tw-shadow: 0 0 20px var(--accent-hot-pink); box-shadow: var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-shadow);">
            <h3 id="modal-title" class="text-xl font-bold mb-4 neon-text-pink"></h3>
            <p id="modal-message" class="mb-6"></p>
            <div id="modal-buttons" class="flex justify-end space-x-4"></div>
        </div>
    </div>

    <script type="module">
        // ===================================================================================
        // INITIALIZATION AND STATE MANAGEMENT
        // ===================================================================================
        
        const appContainer = document.getElementById('app-container');

        function getInitialState() {
            return {
                currentViewIndex: 0,
                presenterNotesVisible: false,
                views: [
                    {
                        type: 'presentation',
                        mode: 'present', // 'edit' or 'present'
                        activeSlideIndex: 0,
                        presenterNotes: 'Notes for the whole presentation deck.',
                        deck: [
                            {
                                title: 'Welcome to the Grid',
                                subtitle: 'Your Cyberpunk Dashboard Awaits',
                                presenterNotes: 'Notes for slide 1.',
                                widget: null
                            }
                        ]
                    }
                ],
                timerInterval: null,
                audioContext: null
            };
        }

        let state = getInitialState();

        // ===================================================================================
        // CORE RENDER FUNCTION
        // ===================================================================================
        
        function renderApp() {
            appContainer.innerHTML = '';
            const mainLayout = document.createElement('div');
            mainLayout.className = 'flex h-full w-full';
            mainLayout.appendChild(renderSidebar());
            mainLayout.appendChild(renderMainContent());
            appContainer.appendChild(mainLayout);
            attachEventListeners();
            lucide.createIcons();
        }

        // ===================================================================================
        // UI COMPONENT RENDERERS
        // ===================================================================================

        function renderSidebar() {
            const sidebar = document.createElement('aside');
            sidebar.className = 'w-64 bg-midnight-blue p-4 flex flex-col space-y-4 border-r-2 border-glitch-purple overflow-y-auto';
            const currentViewIsPresentation = state.views[state.currentViewIndex]?.type === 'presentation';

            sidebar.innerHTML = `
                <div class="flex-shrink-0">
                    <h1 class="text-xl font-bold neon-text-green">Presenter Dash</h1>
                </div>

                <div class="border-t border-border-color pt-4">
                    <h2 class="font-semibold mb-2 text-electric-blue opacity-80 uppercase tracking-widest">Global Controls</h2>
                    <div class="space-y-2">
                        <button id="btn-fullscreen" class="w-full flex items-center space-x-2 p-2 rounded-md hover:bg-glitch-purple/30 transition-colors"><i data-lucide="maximize"></i><span>Fullscreen</span></button>
                    </div>
                </div>

                <div class="border-t border-border-color pt-4">
                    <h2 class="font-semibold mb-2 text-electric-blue opacity-80 uppercase tracking-widest">Session</h2>
                    <div class="space-y-2">
                        <button id="btn-save-state" class="w-full flex items-center justify-center space-x-2 p-2 rounded-md border border-neon-green text-neon-green hover:bg-neon-green hover:text-deep-charcoal transition-all duration-200 hover:shadow-[0_0_15px_var(--text-neon-green)]"><i data-lucide="save"></i><span>Save State</span></button>
                        <label class="w-full flex items-center justify-center space-x-2 p-2 rounded-md border border-electric-blue text-electric-blue hover:bg-electric-blue hover:text-deep-charcoal transition-all duration-200 hover:shadow-[0_0_15px_var(--text-electric-blue)] cursor-pointer"><i data-lucide="upload"></i><span>Load State</span><input type="file" id="input-load-state" class="hidden" accept=".json"></label>
                        <button id="btn-reset-app" class="w-full flex items-center justify-center space-x-2 p-2 rounded-md border border-hot-pink text-hot-pink hover:bg-hot-pink hover:text-deep-charcoal transition-all duration-200 hover:shadow-[0_0_15px_var(--accent-hot-pink)]"><i data-lucide="refresh-cw"></i><span>Reset App</span></button>
                    </div>
                </div>

                <div class="border-t border-border-color pt-4">
                    <h2 class="font-semibold mb-2 text-electric-blue opacity-80 uppercase tracking-widest">Add New View</h2>
                    <div class="space-y-2">
                        ${getFeatureButtonsHTML()}
                    </div>
                </div>
                
                <div class="border-t border-border-color pt-4 flex-grow">
                    <h2 class="font-semibold mb-2 uppercase tracking-widest ${!currentViewIsPresentation ? 'text-electric-blue/40' : 'text-electric-blue/80'}">Add Widget to Slide</h2>
                    <div class="space-y-2">
                        ${getWidgetButtonsHTML(currentViewIsPresentation)}
                    </div>
                </div>
            `;
            return sidebar;
        }
        
        function getFeatureButtonsHTML() {
            const features = [
                { type: 'presentation', label: 'Presentation Deck', icon: 'layout-template' },
                { type: 'poll', label: 'Standalone Poll', icon: 'pie-chart' },
                { type: 'qna', label: 'Standalone Q&A', icon: 'messages-square' },
                { type: 'quiz', label: 'Standalone Quiz', icon: 'file-question' },
                { type: 'timer', label: 'Standalone Timer', icon: 'timer' },
                { type: 'wordcloud', label: 'Standalone Word Cloud', icon: 'cloud' },
                { type: 'agenda', label: 'Standalone Agenda', icon: 'list-checks' },
                { type: 'stickynotes', label: 'Standalone Sticky Notes', icon: 'sticky-note' },
                { type: 'qrcode', label: 'Standalone QR Code', icon: 'qr-code' },
                { type: 'video', label: 'Standalone Video', icon: 'video' },
                { type: 'image', label: 'Standalone Image', icon: 'image' },
            ];
            return features.map(f => `
                <button class="btn-add-view w-full flex items-center space-x-2 p-2 rounded-md hover:bg-glitch-purple/30 transition-colors" data-view-type="${f.type}">
                    <i data-lucide="${f.icon}"></i><span>${f.label}</span>
                </button>
            `).join('');
        }

        function getWidgetButtonsHTML(enabled) {
            const widgets = [
                { type: 'poll', label: 'Live Poll', icon: 'pie-chart' },
                { type: 'qna', label: 'Q&A Session', icon: 'messages-square' },
                { type: 'wordcloud', label: 'Word Cloud', icon: 'cloud' },
                { type: 'quiz', label: 'Quiz / Trivia', icon: 'file-question' },
                { type: 'agenda', label: 'Agenda', icon: 'list-checks' },
                { type: 'stickynotes', label: 'Sticky Notes', icon: 'sticky-note' },
                { type: 'timer', label: 'Timer', icon: 'timer' },
                { type: 'qrcode', label: 'QR Code', icon: 'qr-code' },
                { type: 'video', label: 'Video Player', icon: 'video' },
                { type: 'image', label: 'Image', icon: 'image' },
            ];
            return widgets.map(w => `
                <button class="btn-add-widget-to-slide w-full flex items-center space-x-2 p-2 rounded-md hover:bg-glitch-purple/30 transition-colors disabled:opacity-30 disabled:cursor-not-allowed" data-widget-type="${w.type}" ${!enabled ? 'disabled' : ''}>
                    <i data-lucide="${w.icon}"></i><span>${w.label}</span>
                </button>
            `).join('');
        }

        function renderMainContent() {
            const mainContent = document.createElement('main');
            mainContent.className = 'flex-1 flex flex-col bg-deep-charcoal p-4 md:p-8 overflow-hidden';
            const slideContainer = document.createElement('div');
            slideContainer.id = 'slide-container';
            slideContainer.className = 'flex-1 bg-midnight-blue/50 rounded-lg shadow-lg flex flex-col p-6 relative overflow-y-auto border border-glitch-purple/30';
            
            const currentView = state.views[state.currentViewIndex];
            if (currentView) {
                switch(currentView.type) {
                    case 'presentation':
                        slideContainer.appendChild(renderPresentationView(currentView));
                        break;
                    default: // It's a single-widget view
                        slideContainer.appendChild(renderWidget(currentView));
                }
            } else {
                slideContainer.innerHTML = `<div class="m-auto text-center"><h2 class="text-2xl font-bold neon-text-green">Empty Dashboard</h2><p>Add a view from the sidebar to get started.</p></div>`;
            }

            mainContent.appendChild(slideContainer);
            mainContent.appendChild(renderNavigation());
            mainContent.appendChild(renderPresenterNotes());
            mainContent.appendChild(renderFloatingReactionsContainer());
            return mainContent;
        }
        
        function renderNavigation() {
            const nav = document.createElement('div');
            nav.className = 'flex-shrink-0 flex items-center justify-between p-4';
            
            nav.innerHTML = `
                <button id="btn-prev-view" class="p-2 rounded-full hover:bg-glitch-purple/30 transition-colors disabled:opacity-30 disabled:cursor-not-allowed" ${state.currentViewIndex === 0 ? 'disabled' : ''}>
                    <i data-lucide="arrow-left"></i>
                </button>
                <div class="flex items-center space-x-4">
                    <span class="text-sm font-medium uppercase">View ${state.currentViewIndex + 1} of ${state.views.length}</span>
                    <button id="btn-toggle-notes" class="p-2 rounded-full hover:bg-glitch-purple/30 transition-colors">
                        <i data-lucide="notebook-tabs"></i>
                    </button>
                     <button id="btn-delete-view" class="p-2 rounded-full text-hot-pink hover:bg-hot-pink/20 transition-colors">
                        <i data-lucide="trash-2"></i>
                    </button>
                </div>
                <button id="btn-next-view" class="p-2 rounded-full hover:bg-glitch-purple/30 transition-colors disabled:opacity-30 disabled:cursor-not-allowed" ${state.currentViewIndex >= state.views.length - 1 ? 'disabled' : ''}>
                    <i data-lucide="arrow-right"></i>
                </button>
            `;
            return nav;
        }

        function renderPresenterNotes() {
            const notesContainer = document.createElement('div');
            const currentView = state.views[state.currentViewIndex];
            let currentNotes = '';
            if (currentView?.type === 'presentation') {
                currentNotes = currentView.deck[currentView.activeSlideIndex]?.presenterNotes || '';
            } else {
                currentNotes = currentView?.presenterNotes || '';
            }

            notesContainer.className = `presenter-notes flex-shrink-0 overflow-hidden ${state.presenterNotesVisible ? 'h-40' : 'h-0'}`;
            notesContainer.innerHTML = `
                <div class="p-4 border-t-2 border-glitch-purple/50 h-full">
                    <h3 class="font-semibold mb-2 uppercase tracking-widest">Presenter Notes</h3>
                    <textarea id="presenter-notes-textarea" class="w-full h-24 p-2 bg-deep-charcoal rounded-md resize-none border border-border-color focus:ring-2 focus:ring-hot-pink focus:outline-none">${currentNotes}</textarea>
                </div>
            `;
            return notesContainer;
        }
        
        function renderFloatingReactionsContainer() {
            const reactionsContainer = document.createElement('div');
            reactionsContainer.id = 'reactions-container';
            reactionsContainer.className = 'absolute bottom-20 right-8 flex flex-col space-y-2 bg-midnight-blue/80 border border-glitch-purple/50 p-2 rounded-lg shadow-lg';
            
            const emojis = ['👍', '❤️', '😂', '😮', '👏'];
            emojis.forEach(emoji => {
                const button = document.createElement('button');
                button.className = 'reaction-btn text-2xl hover:scale-125 transition-transform';
                button.textContent = emoji;
                button.dataset.emoji = emoji;
                reactionsContainer.appendChild(button);
            });
            
            return reactionsContainer;
        }

        // ===================================================================================
        // TOP-LEVEL VIEW & WIDGET RENDERERS
        // ===================================================================================

        function renderPresentationView(viewData) {
            const presentationContainer = document.createElement('div');
            presentationContainer.className = 'w-full h-full flex flex-col';

            const header = document.createElement('div');
            header.className = 'flex-shrink-0 flex items-center justify-between mb-4';
            header.innerHTML = `
                <h2 class="text-2xl font-bold neon-text-green">Presentation Deck</h2>
                <div class="flex items-center space-x-2">
                    <span class="text-sm font-medium uppercase">Mode:</span>
                    <button id="btn-present-mode-edit" class="px-3 py-1 text-sm rounded-md ${viewData.mode === 'edit' ? 'bg-hot-pink text-deep-charcoal' : 'bg-deep-charcoal border border-electric-blue'}">Edit</button>
                    <button id="btn-present-mode-present" class="px-3 py-1 text-sm rounded-md ${viewData.mode === 'present' ? 'bg-hot-pink text-deep-charcoal' : 'bg-deep-charcoal border border-electric-blue'}">Present</button>
                </div>
            `;
            presentationContainer.appendChild(header);

            const contentArea = document.createElement('div');
            contentArea.className = 'flex-grow';

            if (viewData.mode === 'edit') {
                contentArea.innerHTML = renderPresentationEditMode(viewData);
            } else {
                contentArea.appendChild(renderPresentationPresentMode(viewData));
            }
            presentationContainer.appendChild(contentArea);
            
            return presentationContainer;
        }

        function renderPresentationEditMode(viewData) {
            return `
                <div class="h-full flex flex-col">
                    <div class="flex-grow space-y-3 overflow-y-auto pr-2">
                        ${viewData.deck.map((slide, index) => `
                            <div class="bg-deep-charcoal/50 p-3 rounded-lg border-l-4 ${index === viewData.activeSlideIndex ? 'border-neon-green' : 'border-transparent'}">
                                <div class="flex items-center justify-between">
                                    <div class="flex-grow">
                                        <input type="text" value="${slide.title}" data-index="${index}" class="presentation-edit-title w-full text-lg font-semibold bg-transparent focus:outline-none focus:ring-1 focus:ring-hot-pink rounded p-1" placeholder="Slide Title">
                                        <input type="text" value="${slide.subtitle}" data-index="${index}" class="presentation-edit-subtitle w-full text-sm text-electric-blue/80 bg-transparent focus:outline-none focus:ring-1 focus:ring-hot-pink rounded p-1" placeholder="Subtitle">
                                    </div>
                                    <div class="flex-shrink-0 flex items-center space-x-2 ml-4">
                                         <span class="text-xs px-2 py-1 rounded-full ${slide.widget ? 'bg-electric-blue text-deep-charcoal' : 'bg-deep-charcoal text-electric-blue'}">${slide.widget ? slide.widget.type : 'No Widget'}</span>
                                        <button class="btn-delete-presentation-slide p-2 text-hot-pink hover:bg-hot-pink/20 rounded-full" data-index="${index}"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-6 text-center flex-shrink-0">
                        <button class="btn-add-presentation-slide px-6 py-3 border border-neon-green text-neon-green rounded-lg hover:bg-neon-green hover:text-deep-charcoal transition-all duration-200 hover:shadow-[0_0_15px_var(--text-neon-green)]">Add New Slide</button>
                    </div>
                </div>
            `;
        }
        
        function renderPresentationPresentMode(viewData) {
            const slide = viewData.deck[viewData.activeSlideIndex];
            if (!slide) {
                const el = document.createElement('div');
                el.textContent = 'No slides in this deck.';
                return el;
            }

            const container = document.createElement('div');
            container.className = 'w-full h-full flex flex-col items-center justify-center text-center relative';

            const baseContent = document.createElement('div');
            if (slide.widget) {
                baseContent.innerHTML = `<h1 class="text-3xl font-bold mb-4 neon-text-green">${slide.title}</h1>`;
            } else {
                baseContent.innerHTML = `<h1 class="text-5xl font-bold neon-text-green">${slide.title}</h1><p class="text-xl mt-4 text-electric-blue">${slide.subtitle}</p>`;
            }
            container.appendChild(baseContent);
            
            if (slide.widget) {
                const widgetContainer = document.createElement('div');
                widgetContainer.className = 'w-full flex-grow mt-4';
                widgetContainer.appendChild(renderWidget(slide.widget));
                container.appendChild(widgetContainer);
            }

            const nav = document.createElement('div');
            nav.className = "absolute bottom-0 w-full flex justify-between items-center px-4 py-2";
            nav.innerHTML = `
                 <button id="btn-deck-prev" class="p-2 rounded-full bg-glitch-purple/30 hover:bg-glitch-purple/60 text-electric-blue disabled:opacity-0 transition-all" ${viewData.activeSlideIndex === 0 ? 'disabled' : ''}><i data-lucide="arrow-left"></i></button>
                <span class="text-sm font-medium px-3 py-1 rounded-full bg-black/20 text-white">${viewData.activeSlideIndex + 1} / ${viewData.deck.length}</span>
                <button id="btn-deck-next" class="p-2 rounded-full bg-glitch-purple/30 hover:bg-glitch-purple/60 text-electric-blue disabled:opacity-0 transition-all" ${viewData.activeSlideIndex >= viewData.deck.length - 1 ? 'disabled' : ''}><i data-lucide="arrow-right"></i></button>
            `;
            container.appendChild(nav);

            return container;
        }

        function renderWidget(widgetData) {
            const widgetContainer = document.createElement('div');
            widgetContainer.className = 'w-full h-full flex flex-col items-center justify-center';
            const specificWidget = getWidgetRenderer(widgetData.type);
            if(specificWidget) {
                widgetContainer.appendChild(specificWidget(widgetData));
            } else {
                widgetContainer.textContent = `Unknown widget type: ${widgetData.type}`;
            }
            return widgetContainer;
        }

        function getWidgetRenderer(type) {
             const renderers = {
                poll: renderPollWidget, qna: renderQnaWidget, wordcloud: renderWordCloudWidget,
                quiz: renderQuizWidget, agenda: renderAgendaWidget, stickynotes: renderStickyNotesWidget,
                timer: renderTimerWidget, qrcode: renderQRCodeWidget, video: renderVideoWidget,
                image: renderImageWidget
            };
            return renderers[type];
        }

        function renderPollWidget(data) {
            const widget = document.createElement('div');
            widget.className = 'w-full max-w-4xl mx-auto';
            const totalVotes = data.options.reduce((sum, opt) => sum + opt.votes, 0);

            widget.innerHTML = `
                <input type="text" value="${data.question}" class="widget-poll-question text-3xl font-bold text-center mb-8 bg-transparent w-full focus:outline-none focus:ring-2 focus:ring-hot-pink rounded-md p-2 neon-text-green" placeholder="Type your poll question here...">
                <div class="space-y-4">
                    ${data.options.map((opt, index) => `
                        <div class="relative bg-deep-charcoal border border-glitch-purple/50 rounded-lg p-4">
                            <div class="absolute top-0 left-0 h-full bg-glitch-purple rounded-lg transition-all duration-500" style="width: ${totalVotes > 0 ? (opt.votes / totalVotes * 100) : 0}%;"></div>
                            <div class="relative flex justify-between items-center">
                                <input type="text" value="${opt.text}" class="widget-poll-option-text bg-transparent w-2/3 focus:outline-none focus:ring-1 focus:ring-hot-pink rounded p-1" data-index="${index}" placeholder="Option text">
                                <div class="flex items-center space-x-4">
                                    <span class="font-bold text-lg">${opt.votes} votes</span>
                                    <button class="btn-poll-vote p-2 rounded-full bg-electric-blue/50 hover:bg-electric-blue text-deep-charcoal" data-index="${index}"><i data-lucide="plus" class="pointer-events-none"></i></button>
                                    <button class="btn-poll-remove-option p-2 rounded-full text-hot-pink hover:bg-hot-pink/20" data-index="${index}"><i data-lucide="x" class="pointer-events-none"></i></button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="mt-6 flex justify-center space-x-4">
                    <button class="btn-poll-add-option p-2 border border-electric-blue rounded-md hover:bg-electric-blue hover:text-deep-charcoal transition-colors">Add Option</button>
                    <button class="btn-poll-reset-votes p-2 border border-electric-blue rounded-md hover:bg-electric-blue hover:text-deep-charcoal transition-colors">Reset Votes</button>
                </div>
            `;
            return widget;
        }
        
        function renderQnaWidget(data) {
            const widget = document.createElement('div');
            widget.className = 'w-full h-full flex flex-col max-w-5xl mx-auto';
            widget.innerHTML = `
                <h2 class="text-3xl font-bold text-center mb-4 neon-text-green">Q&A Session</h2>
                <div class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-6 overflow-hidden">
                    <div class="flex flex-col">
                        <h3 class="font-semibold mb-2 uppercase">Submit a Question</h3>
                        <form id="qna-form" class="flex space-x-2">
                            <input type="text" id="qna-input" class="flex-grow p-2 rounded-md bg-deep-charcoal border border-glitch-purple/50 focus:ring-hot-pink focus:outline-none" placeholder="Ask anything...">
                            <button type="submit" class="p-2 bg-hot-pink text-deep-charcoal rounded-md hover:shadow-[0_0_15px_var(--accent-hot-pink)]"><i data-lucide="send"></i></button>
                        </form>
                        <h3 class="font-semibold mt-4 mb-2 uppercase">Incoming (${data.questions.filter(q => !q.displayed).length})</h3>
                        <div class="flex-grow bg-deep-charcoal/50 rounded-lg p-2 overflow-y-auto space-y-2 border border-border-color">
                            ${data.questions.filter(q => !q.displayed).map((q, index) => `
                                <div class="bg-midnight-blue/70 p-3 rounded-md shadow flex justify-between items-center">
                                    <p>${q.text}</p>
                                    <div class="flex-shrink-0 space-x-1">
                                        <button class="btn-qna-display p-1 text-neon-green hover:bg-neon-green/20 rounded-full" data-id="${q.id}"><i data-lucide="arrow-up-right-square" class="pointer-events-none"></i></button>
                                        <button class="btn-qna-delete p-1 text-hot-pink hover:bg-hot-pink/20 rounded-full" data-id="${q.id}"><i data-lucide="trash-2" class="pointer-events-none"></i></button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <h3 class="font-semibold mb-2 uppercase">Displayed (${data.questions.filter(q => q.displayed).length})</h3>
                        <div class="flex-grow bg-deep-charcoal/50 rounded-lg p-4 overflow-y-auto space-y-3 border border-border-color">
                            ${data.questions.filter(q => q.displayed).map((q, index) => `
                                <div class="bg-glitch-purple/30 border border-glitch-purple p-4 rounded-lg shadow-lg flex justify-between items-start">
                                    <p class="font-medium text-lg">${q.text}</p>
                                    <button class="btn-qna-hide p-1 text-cyber-yellow hover:bg-cyber-yellow/20 rounded-full flex-shrink-0 ml-2" data-id="${q.id}"><i data-lucide="arrow-down-left-square" class="pointer-events-none"></i></button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            return widget;
        }

        function renderWordCloudWidget(data) {
            const widget = document.createElement('div');
            widget.className = 'w-full h-full flex flex-col items-center justify-center';
            const wordCloudContainer = document.createElement('div');
            wordCloudContainer.className = 'w-full max-w-4xl flex-grow flex flex-wrap items-center justify-center gap-4 p-4 border-2 border-dashed border-glitch-purple rounded-lg';
            const words = Object.entries(data.words);
            const colors = [ 'neon-text-green', 'neon-text-pink', 'text-electric-blue neon-text', 'text-cyber-yellow neon-text' ];
            if (words.length > 0) {
                const maxCount = Math.max(...words.map(([, count]) => count));
                words.sort((a, b) => b[1] - a[1]).forEach(([word, count], i) => {
                    const span = document.createElement('span');
                    const size = 1 + (count / maxCount) * 4;
                    span.textContent = word;
                    span.style.fontSize = `${size}rem`;
                    span.style.opacity = 0.6 + (count / maxCount) * 0.4;
                    span.className = `font-bold p-2 ${colors[i % colors.length]}`;
                    wordCloudContainer.appendChild(span);
                });
            } else {
                wordCloudContainer.innerHTML = `<p class="text-electric-blue/70">Submit words below to generate the cloud!</p>`;
            }
            widget.innerHTML = `<h2 class="text-3xl font-bold mb-4 neon-text-green">Word Cloud</h2>`;
            widget.appendChild(wordCloudContainer);
            widget.innerHTML += `<div class="mt-4 w-full max-w-2xl"><form id="wordcloud-form" class="flex space-x-2"><input type="text" id="wordcloud-input" class="flex-grow p-2 rounded-md bg-deep-charcoal border border-glitch-purple/50 focus:ring-hot-pink focus:outline-none" placeholder="Enter words..."><button type="submit" class="p-2 bg-hot-pink text-deep-charcoal rounded-md hover:shadow-[0_0_15px_var(--accent-hot-pink)]">Submit</button></form></div>`;
            return widget;
        }
        
        function renderQuizWidget(data) {
            const widget = document.createElement('div');
            widget.className = 'w-full h-full flex flex-col';
            widget.innerHTML = `<div class="flex-shrink-0 flex items-center justify-between mb-4"><h2 class="text-3xl font-bold neon-text-green">Quiz / Trivia</h2><div class="flex items-center space-x-2"><button id="btn-quiz-mode-edit" class="px-3 py-1 text-sm rounded-md ${data.mode === 'edit' ? 'bg-hot-pink text-deep-charcoal' : 'bg-deep-charcoal border border-electric-blue'}">Edit</button><button id="btn-quiz-mode-display" class="px-3 py-1 text-sm rounded-md ${data.mode === 'display' ? 'bg-hot-pink text-deep-charcoal' : 'bg-deep-charcoal border border-electric-blue'}">Display</button></div></div><div class="flex-grow">${data.mode === 'edit' ? renderQuizEditMode(data) : renderQuizDisplayMode(data)}</div>`;
            return widget;
        }
        
        function renderQuizEditMode(data) {
            const editingQuestion = data.editingQuestionIndex !== null ? data.questions[data.editingQuestionIndex] : null;
            if (editingQuestion) {
                return `<div class="bg-deep-charcoal/50 p-4 rounded-lg border border-border-color"><h3 class="text-xl font-semibold mb-2">Editing Question ${data.editingQuestionIndex + 1}</h3><textarea class="quiz-edit-question-text w-full p-2 rounded-md bg-midnight-blue border border-border-color" rows="2" placeholder="Question Text">${editingQuestion.questionText}</textarea><h4 class="font-semibold mt-4 mb-2">Options:</h4><div class="space-y-2">${editingQuestion.options.map((opt, optIndex) => `<div class="flex items-center space-x-2"><input type="radio" name="quiz-correct-option" class="quiz-edit-correct-option w-5 h-5 text-neon-green bg-deep-charcoal border-border-color focus:ring-neon-green" data-opt-index="${optIndex}" ${opt.correct ? 'checked' : ''}><input type="text" value="${opt.text}" class="quiz-edit-option-text flex-grow p-2 rounded-md bg-midnight-blue border border-border-color" data-opt-index="${optIndex}" placeholder="Option text"><button class="btn-quiz-delete-option p-2 text-hot-pink hover:bg-hot-pink/20 rounded-full" data-opt-index="${optIndex}"><i data-lucide="x" class="pointer-events-none"></i></button></div>`).join('')}</div><div class="mt-4 flex justify-between"><button class="btn-quiz-add-option text-sm p-2 border border-electric-blue rounded-md hover:bg-electric-blue hover:text-deep-charcoal">Add Option</button><button class="btn-quiz-save-question px-4 py-2 bg-neon-green text-deep-charcoal rounded-md hover:shadow-[0_0_15px_var(--text-neon-green)]">Save and Close</button></div></div>`;
            } else {
                return `<div class="space-y-3">${data.questions.map((q, index) => `<div class="bg-deep-charcoal/50 p-3 rounded-lg flex items-center justify-between"><p class="font-medium flex-grow truncate pr-4">${index + 1}. ${q.questionText || '<em>Untitled Question</em>'}</p><div class="flex-shrink-0 flex items-center space-x-2"><button class="btn-quiz-present px-3 py-1 text-sm rounded-md ${data.currentQuestionIndex === index ? 'bg-neon-green text-deep-charcoal' : 'bg-electric-blue hover:bg-electric-blue/80 text-deep-charcoal'} " data-index="${index}">Present</button><button class="btn-quiz-edit-question p-2 hover:bg-glitch-purple/30 rounded-full" data-index="${index}"><i data-lucide="edit" class="w-4 h-4 pointer-events-none"></i></button><button class="btn-quiz-delete-question p-2 text-hot-pink hover:bg-hot-pink/20 rounded-full" data-index="${index}"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button></div></div>`).join('')}</div><div class="mt-6 text-center"><button class="btn-quiz-add-question px-6 py-3 border border-neon-green text-neon-green rounded-lg hover:bg-neon-green hover:text-deep-charcoal transition-all duration-200 hover:shadow-[0_0_15px_var(--text-neon-green)]">Add New Question</button></div>`;
            }
        }

        function renderQuizDisplayMode(data) {
            const question = data.questions[data.currentQuestionIndex];
            if (!question) {
                return `<div class="text-center text-electric-blue/70">No question is selected to present. Go to Edit Mode to select one.</div>`;
            }
            const reveal = question.revealed;
            return `<div class="w-full max-w-4xl mx-auto text-center flex flex-col h-full"><h3 class="text-3xl font-bold mb-8">${question.questionText}</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4 flex-grow">${question.options.map((opt, index) => { let bgClass = 'bg-deep-charcoal border border-electric-blue hover:bg-electric-blue hover:text-deep-charcoal'; if (reveal) { bgClass = opt.correct ? 'bg-neon-green text-deep-charcoal neon-text' : 'bg-hot-pink text-deep-charcoal neon-text'; } return `<div class="p-4 rounded-lg flex items-center justify-center text-lg font-medium transition-colors ${bgClass}">${opt.text}</div>`; }).join('')}</div><div class="mt-8 flex-shrink-0 flex justify-center items-center space-x-4"><button id="btn-quiz-prev-q" class="p-2 rounded-full hover:bg-glitch-purple/30" ${data.currentQuestionIndex === 0 ? 'disabled' : ''}><i data-lucide="arrow-left"></i></button><button id="btn-quiz-reveal" class="px-6 py-3 text-lg rounded-lg bg-cyber-yellow hover:bg-cyber-yellow/80 text-deep-charcoal font-bold transition-colors">${reveal ? 'Answer Revealed' : 'Reveal Answer'}</button><button id="btn-quiz-next-q" class="p-2 rounded-full hover:bg-glitch-purple/30" ${data.currentQuestionIndex >= data.questions.length - 1 ? 'disabled' : ''}><i data-lucide="arrow-right"></i></button></div></div>`;
        }

        function renderAgendaWidget(data) {
            const widget = document.createElement('div');
            widget.className = 'w-full max-w-2xl mx-auto';
            widget.innerHTML = `<h2 class="text-3xl font-bold mb-6 text-center neon-text-green">Agenda / Checklist</h2><ul class="space-y-3">${data.items.map((item, index) => `<li class="flex items-center space-x-4 bg-deep-charcoal/50 p-3 rounded-lg"><input type="checkbox" class="agenda-checkbox h-6 w-6 rounded text-hot-pink focus:ring-hot-pink bg-deep-charcoal border-border-color" data-index="${index}" ${item.done ? 'checked' : ''}><input type="text" value="${item.text}" data-index="${index}" class="agenda-item-text flex-grow bg-transparent text-lg focus:outline-none focus:ring-1 focus:ring-hot-pink rounded p-1 ${item.done ? 'line-through text-electric-blue/50' : ''}" placeholder="Agenda item..."><button class="btn-agenda-delete text-hot-pink hover:text-hot-pink/70" data-index="${index}"><i data-lucide="trash-2"></i></button></li>`).join('')}</ul><div class="mt-6 text-center"><button id="btn-agenda-add" class="p-2 border border-electric-blue rounded-md hover:bg-electric-blue hover:text-deep-charcoal transition-colors">Add Item</button></div>`;
            return widget;
        }
        
        function renderStickyNotesWidget(data) {
            const widget = document.createElement('div');
            widget.className = 'w-full h-full relative';
            widget.innerHTML = `<h2 class="absolute top-0 left-1/2 -translate-x-1/2 text-3xl font-bold neon-text-green">Idea Board</h2>`;
            const board = document.createElement('div');
            board.id = 'sticky-board';
            board.className = 'w-full h-full rounded-lg border-2 border-dashed border-glitch-purple mt-12 relative overflow-hidden';
            data.notes.forEach(note => { const noteEl = document.createElement('div'); noteEl.className = 'sticky-note absolute cursor-grab p-4 w-48 h-48 flex flex-col shadow-lg rounded-md text-deep-charcoal'; noteEl.style.left = `${note.x}px`; noteEl.style.top = `${note.y}px`; noteEl.style.backgroundColor = note.color; noteEl.dataset.id = note.id; noteEl.innerHTML = `<textarea class="sticky-note-text flex-grow bg-transparent resize-none focus:outline-none w-full h-full font-sans">${note.text}</textarea><button class="btn-sticky-delete absolute top-1 right-1 text-black/50 hover:text-black"><i data-lucide="x" class="w-4 h-4"></i></button>`; board.appendChild(noteEl); });
            widget.appendChild(board);
            widget.innerHTML += `<div class="absolute bottom-4 right-4"><button id="btn-sticky-add" class="px-4 py-2 bg-cyber-yellow text-deep-charcoal font-semibold rounded-lg shadow-md hover:bg-cyber-yellow/80">Add Note</button></div>`;
            return widget;
        }
        
        function renderTimerWidget(data) {
            const widget = document.createElement('div');
            widget.className = 'flex flex-col items-center justify-center w-full max-w-2xl mx-auto';
            const isFinished = data.mode === 'countdown' && data.time <= 0;
            const displayTime = formatTime(data.time);
            const countdownInputs = `<div class="flex items-center space-x-2"><input type="number" id="timer-set-minutes" value="${Math.floor(data.setTime / 60)}" min="0" class="w-20 p-1 rounded-md bg-deep-charcoal border border-border-color text-center"><span>min</span><input type="number" id="timer-set-seconds" value="${data.setTime % 60}" min="0" max="59" class="w-20 p-1 rounded-md bg-deep-charcoal border border-border-color text-center"><span>sec</span></div>`;
            const lapList = `<div class="w-full mt-4 h-32 overflow-y-auto border border-border-color rounded-lg p-2"><h4 class="font-semibold text-center mb-2 uppercase">Laps</h4><ul class="space-y-1 text-center">${data.laps.map((lap, i) => `<li class="text-sm">Lap ${i + 1}: ${formatTime(lap)}</li>`).join('')}</ul></div>`;
            widget.innerHTML = `<div class="flex items-center space-x-4 mb-4"><button id="btn-timer-mode-countdown" class="px-4 py-2 rounded-md ${data.mode === 'countdown' ? 'bg-hot-pink text-deep-charcoal' : 'border border-electric-blue'}">Countdown</button><button id="btn-timer-mode-stopwatch" class="px-4 py-2 rounded-md ${data.mode === 'stopwatch' ? 'bg-hot-pink text-deep-charcoal' : 'border border-electric-blue'}">Stopwatch</button></div><div id="timer-display" class="text-8xl font-bold p-4 rounded-lg shadow-inner w-full text-center ${isFinished ? 'timer-finished text-deep-charcoal' : 'bg-black text-neon-green neon-text-green'}">${displayTime}</div><div class="mt-6 flex justify-center space-x-4"><button id="btn-timer-start" class="px-6 py-3 text-lg rounded-lg bg-neon-green hover:bg-neon-green/80 text-deep-charcoal font-bold w-32">${data.running ? 'Pause' : 'Start'}</button>${data.mode === 'stopwatch' ? `<button id="btn-timer-lap" class="px-6 py-3 text-lg rounded-lg bg-electric-blue hover:bg-electric-blue/80 text-deep-charcoal font-bold w-32">Lap</button>` : ''}<button id="btn-timer-reset" class="px-6 py-3 text-lg rounded-lg bg-hot-pink hover:bg-hot-pink/80 text-deep-charcoal font-bold w-32">Reset</button></div><div class="mt-6 w-full text-center">${data.mode === 'countdown' ? countdownInputs : lapList}</div>`;
            return widget;
        }
        
        function renderQRCodeWidget(data) {
            const widget = document.createElement('div');
            widget.className = 'flex flex-col items-center justify-center';
            widget.innerHTML = `<h2 class="text-3xl font-bold mb-4 neon-text-green">QR Code Generator</h2><div id="qrcode-container" class="p-4 bg-white rounded-lg shadow-md"></div><input type="text" id="qrcode-input" value="${data.text}" class="mt-4 w-full max-w-md p-2 rounded-md bg-deep-charcoal border border-border-color focus:ring-hot-pink focus:outline-none" placeholder="Enter URL or text to encode">`;
            setTimeout(() => { const qrContainer = document.getElementById('qrcode-container'); if (qrContainer && data.text) { generateQRCode(qrContainer, data.text); } }, 0);
            return widget;
        }

        function renderVideoWidget(data) {
            const widget = document.createElement('div');
            widget.className = 'w-full max-w-4xl mx-auto flex flex-col items-center';
            const getPlayerHtml = (url) => { if (!url) { return '<div class="w-full h-full flex items-center justify-center text-electric-blue/70">Enter a video URL or upload a file</div>'; } const youtubeEmbedUrl = getYoutubeEmbedUrl(url); if (youtubeEmbedUrl) { return `<iframe class="w-full h-full" src="${youtubeEmbedUrl}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`; } return `<video src="${url}" controls class="w-full h-full"></video>`; };
            widget.innerHTML = `<h2 class="text-3xl font-bold mb-4 neon-text-green">Video Player</h2><div class="w-full aspect-video bg-black rounded-lg overflow-hidden">${getPlayerHtml(data.url)}</div><div class="mt-4 w-full flex flex-col sm:flex-row items-center gap-2"><input type="text" id="video-url-input" value="${data.url.startsWith('blob:') ? '' : data.url}" class="flex-grow w-full p-2 rounded-md bg-deep-charcoal border border-border-color focus:ring-hot-pink focus:outline-none" placeholder="Enter direct video URL or YouTube link"><label class="w-full sm:w-auto px-4 py-2 bg-hot-pink text-deep-charcoal rounded-md hover:bg-hot-pink/80 cursor-pointer text-center"><span>Upload Video</span><input type="file" id="video-file-input" class="hidden" accept="video/*"></label></div>`;
            return widget;
        }
        
        function renderImageWidget(data) {
            const widget = document.createElement('div');
            widget.className = 'w-full h-full flex flex-col items-center justify-center';
            widget.innerHTML = `<h2 class="text-3xl font-bold mb-4 neon-text-green">Image Viewer</h2><div class="w-full h-full flex-grow flex items-center justify-center bg-black/20 rounded-lg overflow-hidden">${data.url ? `<img src="${data.url}" class="max-w-full max-h-full object-contain" onerror="this.onerror=null;this.src='https://placehold.co/600x400/0f0f2e/61dafb?text=Invalid+Image';">` : '<div class="text-electric-blue/70">Enter an image URL below</div>'}</div><input type="text" id="image-url-input" value="${data.url}" class="mt-4 w-full max-w-2xl p-2 rounded-md bg-deep-charcoal border border-border-color focus:ring-hot-pink focus:outline-none" placeholder="Enter image URL">`;
            return widget;
        }

        // ===================================================================================
        // EVENT HANDLERS & LOGIC
        // ===================================================================================

        function attachEventListeners() {
            // Global controls
            document.getElementById('btn-fullscreen')?.addEventListener('click', toggleFullscreen);
            document.getElementById('btn-save-state')?.addEventListener('click', saveState);
            document.getElementById('input-load-state')?.addEventListener('change', loadState);
            document.getElementById('btn-reset-app')?.addEventListener('click', handleResetApp);

            // Main View Navigation
            document.getElementById('btn-prev-view')?.addEventListener('click', () => changeView(-1));
            document.getElementById('btn-next-view')?.addEventListener('click', () => changeView(1));
            document.getElementById('btn-delete-view')?.addEventListener('click', deleteCurrentView);
            document.getElementById('btn-toggle-notes')?.addEventListener('click', togglePresenterNotes);
            document.getElementById('presenter-notes-textarea')?.addEventListener('input', handlePresenterNotesInput);

            // Add new view buttons
            document.querySelectorAll('.btn-add-view').forEach(btn => {
                btn.addEventListener('click', () => addNewView(btn.dataset.viewType));
            });
            
            document.querySelectorAll('.btn-add-widget-to-slide').forEach(btn => {
                btn.addEventListener('click', () => addWidgetToCurrentSlide(btn.dataset.widgetType));
            });

            // Emoji reactions
            document.querySelectorAll('.reaction-btn').forEach(btn => {
                btn.addEventListener('click', () => triggerReaction(btn.dataset.emoji));
            });

            // View-specific listeners
            const currentView = state.views[state.currentViewIndex];
            if (currentView) {
                if (currentView.type === 'presentation') {
                    attachPresentationListeners(currentView);
                    const currentSlide = currentView.deck[currentView.activeSlideIndex];
                    if (currentSlide && currentSlide.widget) {
                        attachWidgetListeners(currentSlide.widget);
                    }
                } else {
                    attachWidgetListeners(currentView);
                }
            }
        }

        function attachWidgetListeners(widgetData) {
            switch(widgetData.type) {
                case 'poll': attachPollListeners(widgetData); break;
                case 'qna': attachQnaListeners(widgetData); break;
                case 'wordcloud': attachWordCloudListeners(widgetData); break;
                case 'quiz': attachQuizListeners(widgetData); break;
                case 'agenda': attachAgendaListeners(widgetData); break;
                case 'stickynotes': attachStickyNotesListeners(widgetData); break;
                case 'timer': attachTimerListeners(widgetData); break;
                case 'qrcode': document.getElementById('qrcode-input')?.addEventListener('input', (e) => handleQRCodeInput(e, widgetData)); break;
                case 'video': 
                    document.getElementById('video-url-input')?.addEventListener('input', (e) => handleVideoUrlInput(e, widgetData));
                    document.getElementById('video-file-input')?.addEventListener('change', (e) => handleVideoFileInput(e, widgetData));
                    break;
                case 'image': document.getElementById('image-url-input')?.addEventListener('input', (e) => handleImageUrlInput(e, widgetData)); break;
            }
        }

        function attachPresentationListeners(viewData) {
            document.getElementById('btn-present-mode-edit')?.addEventListener('click', () => { viewData.mode = 'edit'; renderApp(); });
            document.getElementById('btn-present-mode-present')?.addEventListener('click', () => { viewData.mode = 'present'; renderApp(); });

            if (viewData.mode === 'edit') {
                document.querySelectorAll('.presentation-edit-title').forEach(input => input.addEventListener('input', e => { viewData.deck[e.target.dataset.index].title = e.target.value; }));
                document.querySelectorAll('.presentation-edit-subtitle').forEach(input => input.addEventListener('input', e => { viewData.deck[e.target.dataset.index].subtitle = e.target.value; }));
                document.querySelectorAll('.btn-delete-presentation-slide').forEach(btn => btn.addEventListener('click', e => deletePresentationSlide(viewData, parseInt(e.currentTarget.dataset.index))));
                document.querySelector('.btn-add-presentation-slide')?.addEventListener('click', () => addPresentationSlide(viewData));
            } else {
                document.getElementById('btn-deck-prev')?.addEventListener('click', () => { if(viewData.activeSlideIndex > 0) { viewData.activeSlideIndex--; renderApp(); } });
                document.getElementById('btn-deck-next')?.addEventListener('click', () => { if(viewData.activeSlideIndex < viewData.deck.length - 1) { viewData.activeSlideIndex++; renderApp(); } });
            }
        }
        
        function toggleFullscreen() {
            try {
                if (!document.fullscreenElement) { document.documentElement.requestFullscreen(); } 
                else if (document.exitFullscreen) { document.exitFullscreen(); }
            } catch (error) {
                console.error("Fullscreen API call failed:", error);
            }
        }
        
        function handleResetApp() {
            showModal(
                'Confirm Reset',
                'Are you sure you want to reset the entire application? All current views and data will be lost.',
                [
                    { text: 'Cancel', class: 'bg-deep-charcoal border border-electric-blue text-electric-blue' },
                    { 
                        text: 'Reset', 
                        class: 'bg-hot-pink text-deep-charcoal', 
                        callback: () => {
                            if (state.timerInterval) {
                                clearInterval(state.timerInterval);
                            }
                            state = getInitialState();
                            renderApp();
                        }
                    }
                ]
            );
        }

        function saveState() {
            const stateString = JSON.stringify(state, null, 2);
            const blob = new Blob([stateString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `presenter-dashboard-state-${new Date().toISOString()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function loadState(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const loadedState = JSON.parse(e.target.result);
                    if (loadedState.views && Array.isArray(loadedState.views)) {
                        state = loadedState;
                        renderApp();
                    } else {
                        showModal('Error', 'Invalid state file format.', [{ text: 'OK', class: 'bg-hot-pink text-deep-charcoal' }]);
                    }
                } catch (error) {
                    console.error('Error loading state:', error);
                    showModal('Error', 'Could not parse state file. It may be corrupted.', [{ text: 'OK', class: 'bg-hot-pink text-deep-charcoal' }]);
                }
            };
            reader.readAsText(file);
        }
        
        function changeView(direction) {
            const newIndex = state.currentViewIndex + direction;
            if (newIndex >= 0 && newIndex < state.views.length) {
                if (state.timerInterval) { clearInterval(state.timerInterval); state.timerInterval = null; }
                state.currentViewIndex = newIndex;
                renderApp();
            }
        }

        function deleteCurrentView() {
            if (state.views.length <= 1) {
                showModal('Action Denied', 'You cannot delete the last view.', [{ text: 'OK', class: 'bg-electric-blue text-deep-charcoal' }]);
                return;
            }
            showModal('Confirm Deletion', `Are you sure you want to delete this entire view?`, [
                { text: 'Cancel', class: 'bg-deep-charcoal border border-electric-blue text-electric-blue' },
                { text: 'Delete', class: 'bg-hot-pink text-deep-charcoal', callback: () => {
                    state.views.splice(state.currentViewIndex, 1);
                    if (state.currentViewIndex >= state.views.length) {
                        state.currentViewIndex = state.views.length - 1;
                    }
                    renderApp();
                }}
            ]);
        }
        
        function togglePresenterNotes() {
            state.presenterNotesVisible = !state.presenterNotesVisible;
            renderApp();
        }
        
        function handlePresenterNotesInput(event) {
            const currentView = state.views[state.currentViewIndex];
            if (currentView?.type === 'presentation') {
                currentView.deck[currentView.activeSlideIndex].presenterNotes = event.target.value;
            } else if (currentView) {
                currentView.presenterNotes = event.target.value;
            }
        }
        
        function triggerReaction(emoji) {
            const slideContainer = document.getElementById('slide-container');
            const reaction = document.createElement('div');
            reaction.className = 'reaction-emoji';
            reaction.textContent = emoji;
            reaction.style.left = `${Math.random() * 80 + 10}%`;
            slideContainer.appendChild(reaction);
            setTimeout(() => reaction.remove(), 3000);
        }
        
        function addNewView(type) {
            let newView;
            const baseView = { type, presenterNotes: `Notes for this ${type} view.` };
            switch(type) {
                case 'presentation': newView = { ...baseView, type: 'presentation', mode: 'edit', activeSlideIndex: 0, deck: [{ title: 'New Presentation', subtitle: '', presenterNotes: '', widget: null }] }; break;
                case 'poll': newView = {...baseView, question: 'What do you think?', options: [{text: 'Option A', votes: 0}, {text: 'Option B', votes: 0}]}; break;
                case 'qna': newView = {...baseView, questions: []}; break;
                case 'wordcloud': newView = {...baseView, words: {}}; break;
                case 'quiz': newView = {...baseView, mode: 'edit', questions: [], currentQuestionIndex: null, editingQuestionIndex: null}; break;
                case 'agenda': newView = {...baseView, items: [{text: 'First item', done: false}, {text: 'Second item', done: false}]}; break;
                case 'stickynotes': newView = {...baseView, notes: []}; break;
                case 'timer': newView = {...baseView, mode: 'countdown', time: 300, setTime: 300, running: false, laps: []}; break;
                case 'qrcode': newView = {...baseView, text: 'https://google.com'}; break;
                case 'video': newView = {...baseView, url: ''}; break;
                case 'image': newView = {...baseView, url: ''}; break;
                default: return;
            }
            state.views.push(newView);
            state.currentViewIndex = state.views.length - 1;
            renderApp();
        }

        function addWidgetToCurrentSlide(type) {
            const currentView = state.views[state.currentViewIndex];
            if (currentView.type !== 'presentation') return;

            const currentSlide = currentView.deck[currentView.activeSlideIndex];
            if (!currentSlide) return;

            const createWidget = () => {
                let newWidget;
                const baseWidget = { type };
                switch(type) {
                    case 'poll': newWidget = {...baseWidget, question: 'What do you think?', options: [{text: 'Option A', votes: 0}, {text: 'Option B', votes: 0}]}; break;
                    case 'qna': newWidget = {...baseWidget, questions: []}; break;
                    case 'wordcloud': newWidget = {...baseWidget, words: {}}; break;
                    case 'quiz': newWidget = {...baseWidget, mode: 'edit', questions: [], currentQuestionIndex: null, editingQuestionIndex: null}; break;
                    case 'agenda': newWidget = {...baseWidget, items: [{text: 'First item', done: false}, {text: 'Second item', done: false}]}; break;
                    case 'stickynotes': newWidget = {...baseWidget, notes: []}; break;
                    case 'timer': newWidget = {...baseWidget, mode: 'countdown', time: 300, setTime: 300, running: false, laps: []}; break;
                    case 'qrcode': newWidget = {...baseWidget, text: 'https://google.com'}; break;
                    case 'video': newWidget = {...baseWidget, url: ''}; break;
                    case 'image': newWidget = {...baseWidget, url: ''}; break;
                    default: return;
                }
                currentSlide.widget = newWidget;
                currentView.mode = 'present';
                renderApp();
            };

            if (currentSlide.widget) {
                showModal('Replace Widget', 'This slide already has a widget. Do you want to replace it?', [
                    { text: 'Cancel', class: 'bg-deep-charcoal border border-electric-blue text-electric-blue' },
                    { text: 'Replace', class: 'bg-hot-pink text-deep-charcoal', callback: createWidget }
                ]);
            } else {
                createWidget();
            }
        }

        function addPresentationSlide(viewData) {
            viewData.deck.push({ title: 'New Slide', subtitle: '', presenterNotes: '', widget: null });
            viewData.activeSlideIndex = viewData.deck.length - 1;
            renderApp();
        }

        function deletePresentationSlide(viewData, indexToDelete) {
            if (viewData.deck.length <= 1) {
                showModal('Action Denied', 'You cannot delete the last slide of a deck.', [{ text: 'OK', class: 'bg-electric-blue text-deep-charcoal' }]);
                return;
            }
            viewData.deck.splice(indexToDelete, 1);
            if (viewData.activeSlideIndex >= viewData.deck.length) {
                viewData.activeSlideIndex = viewData.deck.length - 1;
            }
            renderApp();
        }

        // --- Widget-Specific Listener Attachers (data passed from main dispatcher) ---
        function attachPollListeners(widgetData) {
            document.querySelector('.widget-poll-question')?.addEventListener('input', e => { widgetData.question = e.target.value; });
            document.querySelectorAll('.widget-poll-option-text').forEach(input => input.addEventListener('input', e => { widgetData.options[e.target.dataset.index].text = e.target.value; }));
            document.querySelectorAll('.btn-poll-vote').forEach(btn => btn.addEventListener('click', e => { widgetData.options[e.currentTarget.dataset.index].votes++; renderApp(); }));
            document.querySelectorAll('.btn-poll-remove-option').forEach(btn => btn.addEventListener('click', e => { widgetData.options.splice(e.currentTarget.dataset.index, 1); renderApp(); }));
            document.querySelector('.btn-poll-add-option')?.addEventListener('click', () => { widgetData.options.push({ text: 'New Option', votes: 0 }); renderApp(); });
            document.querySelector('.btn-poll-reset-votes')?.addEventListener('click', () => { widgetData.options.forEach(opt => opt.votes = 0); renderApp(); });
        }
        
        function attachQnaListeners(widgetData) {
            document.getElementById('qna-form')?.addEventListener('submit', e => { e.preventDefault(); const input = document.getElementById('qna-input'); if (input.value.trim()) { widgetData.questions.push({ id: Date.now(), text: input.value.trim(), displayed: false }); input.value = ''; renderApp(); } });
            document.querySelectorAll('.btn-qna-display').forEach(btn => btn.addEventListener('click', e => { const question = widgetData.questions.find(q => q.id == e.currentTarget.dataset.id); if (question) question.displayed = true; renderApp(); }));
            document.querySelectorAll('.btn-qna-hide').forEach(btn => btn.addEventListener('click', e => { const question = widgetData.questions.find(q => q.id == e.currentTarget.dataset.id); if (question) question.displayed = false; renderApp(); }));
            document.querySelectorAll('.btn-qna-delete').forEach(btn => btn.addEventListener('click', e => { widgetData.questions = widgetData.questions.filter(q => q.id != e.currentTarget.dataset.id); renderApp(); }));
        }
        
        function attachWordCloudListeners(widgetData) {
            document.getElementById('wordcloud-form')?.addEventListener('submit', e => { e.preventDefault(); const input = document.getElementById('wordcloud-input'); const words = input.value.trim().toLowerCase().split(/\s+/); words.forEach(word => { if (word) { widgetData.words[word] = (widgetData.words[word] || 0) + 1; } }); input.value = ''; renderApp(); });
        }
        
        function attachQuizListeners(widgetData) {
            document.getElementById('btn-quiz-mode-edit')?.addEventListener('click', () => { widgetData.mode = 'edit'; renderApp(); });
            document.getElementById('btn-quiz-mode-display')?.addEventListener('click', () => { widgetData.mode = 'display'; renderApp(); });
            if (widgetData.mode === 'edit') {
                if (widgetData.editingQuestionIndex !== null) {
                    const q = widgetData.questions[widgetData.editingQuestionIndex];
                    document.querySelector('.quiz-edit-question-text').addEventListener('input', e => { q.questionText = e.target.value; });
                    document.querySelectorAll('.quiz-edit-option-text').forEach(input => input.addEventListener('input', e => { q.options[e.target.dataset.optIndex].text = e.target.value; }));
                    document.querySelectorAll('.quiz-edit-correct-option').forEach(radio => radio.addEventListener('change', e => { q.options.forEach((opt, i) => opt.correct = (i == e.target.dataset.optIndex)); renderApp(); }));
                    document.querySelectorAll('.btn-quiz-delete-option').forEach(btn => btn.addEventListener('click', e => { q.options.splice(e.currentTarget.dataset.optIndex, 1); renderApp(); }));
                    document.querySelector('.btn-quiz-add-option').addEventListener('click', () => { q.options.push({ text: '', correct: false }); renderApp(); });
                    document.querySelector('.btn-quiz-save-question').addEventListener('click', () => { widgetData.editingQuestionIndex = null; renderApp(); });
                } else {
                    document.querySelector('.btn-quiz-add-question')?.addEventListener('click', () => { widgetData.questions.push({ questionText: '', options: [{ text: 'Option 1', correct: true }, { text: 'Option 2', correct: false }], revealed: false }); widgetData.editingQuestionIndex = widgetData.questions.length - 1; renderApp(); });
                    document.querySelectorAll('.btn-quiz-edit-question').forEach(btn => btn.addEventListener('click', e => { widgetData.editingQuestionIndex = parseInt(e.currentTarget.dataset.index); renderApp(); }));
                    document.querySelectorAll('.btn-quiz-delete-question').forEach(btn => btn.addEventListener('click', e => { widgetData.questions.splice(e.currentTarget.dataset.index, 1); renderApp(); }));
                    document.querySelectorAll('.btn-quiz-present').forEach(btn => btn.addEventListener('click', e => { widgetData.currentQuestionIndex = parseInt(e.currentTarget.dataset.index); widgetData.mode = 'display'; renderApp(); }));
                }
            } else {
                document.getElementById('btn-quiz-reveal')?.addEventListener('click', () => { if (widgetData.currentQuestionIndex !== null) { widgetData.questions[widgetData.currentQuestionIndex].revealed = true; renderApp(); } });
                document.getElementById('btn-quiz-prev-q')?.addEventListener('click', () => { if (widgetData.currentQuestionIndex > 0) { widgetData.currentQuestionIndex--; renderApp(); } });
                document.getElementById('btn-quiz-next-q')?.addEventListener('click', () => { if (widgetData.currentQuestionIndex < widgetData.questions.length - 1) { widgetData.currentQuestionIndex++; renderApp(); } });
            }
        }
        
        function attachAgendaListeners(widgetData) {
            document.querySelectorAll('.agenda-checkbox').forEach(cb => cb.addEventListener('change', e => { widgetData.items[e.target.dataset.index].done = e.target.checked; renderApp(); }));
            document.querySelectorAll('.agenda-item-text').forEach(input => input.addEventListener('input', e => { widgetData.items[e.target.dataset.index].text = e.target.value; }));
            document.querySelectorAll('.btn-agenda-delete').forEach(btn => btn.addEventListener('click', e => { widgetData.items.splice(e.currentTarget.dataset.index, 1); renderApp(); }));
            document.getElementById('btn-agenda-add')?.addEventListener('click', () => { widgetData.items.push({ text: '', done: false }); renderApp(); });
        }
        
        function attachStickyNotesListeners(widgetData) {
            document.getElementById('btn-sticky-add')?.addEventListener('click', () => { const colors = ['#ff00ff', '#f7ff00', '#61dafb', '#9400d3']; widgetData.notes.push({ id: Date.now(), text: 'New idea...', x: 50, y: 50, color: colors[Math.floor(Math.random() * colors.length)] }); renderApp(); });
            document.querySelectorAll('.btn-sticky-delete').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); const noteId = e.currentTarget.closest('.sticky-note').dataset.id; widgetData.notes = widgetData.notes.filter(n => n.id != noteId); renderApp(); }));
            document.querySelectorAll('.sticky-note-text').forEach(textarea => textarea.addEventListener('input', e => { const noteId = e.currentTarget.closest('.sticky-note').dataset.id; const note = widgetData.notes.find(n => n.id == noteId); if(note) note.text = e.target.value; }));
            const board = document.getElementById('sticky-board'); let activeNote = null; let offsetX, offsetY;
            board?.addEventListener('mousedown', e => { if (e.target.classList.contains('sticky-note')) { activeNote = e.target; offsetX = e.clientX - activeNote.offsetLeft; offsetY = e.clientY - activeNote.offsetTop; activeNote.style.cursor = 'grabbing'; activeNote.style.zIndex = 10; } });
            board?.addEventListener('mousemove', e => { if (activeNote) { e.preventDefault(); let newX = e.clientX - offsetX; let newY = e.clientY - offsetY; const boardRect = board.getBoundingClientRect(); newX = Math.max(0, Math.min(newX, boardRect.width - activeNote.offsetWidth)); newY = Math.max(0, Math.min(newY, boardRect.height - activeNote.offsetHeight)); activeNote.style.left = `${newX}px`; activeNote.style.top = `${newY}px`; } });
            board?.addEventListener('mouseup', e => { if (activeNote) { const noteData = widgetData.notes.find(n => n.id == activeNote.dataset.id); if (noteData) { noteData.x = activeNote.offsetLeft; noteData.y = activeNote.offsetTop; } activeNote.style.cursor = 'grab'; activeNote.style.zIndex = 1; activeNote = null; } });
        }
        
        function attachTimerListeners(widgetData) {
            const startTimer = () => { if(state.timerInterval) clearInterval(state.timerInterval); state.timerInterval = setInterval(() => { const currentWidget = findCurrentWidget(); if (!currentWidget || currentWidget.type !== 'timer' || !currentWidget.running) { clearInterval(state.timerInterval); state.timerInterval = null; return; } if (currentWidget.mode === 'countdown') { currentWidget.time--; if (currentWidget.time <= 0) { currentWidget.time = 0; currentWidget.running = false; clearInterval(state.timerInterval); state.timerInterval = null; playTimerEndSound(); } } else { currentWidget.time++; } renderApp(); }, 1000); };
            document.getElementById('btn-timer-start')?.addEventListener('click', () => { widgetData.running = !widgetData.running; if (widgetData.running) { if (!state.audioContext) { state.audioContext = new (window.AudioContext || window.webkitAudioContext)(); } startTimer(); } else { if(state.timerInterval) clearInterval(state.timerInterval); state.timerInterval = null; } renderApp(); });
            document.getElementById('btn-timer-reset')?.addEventListener('click', () => { if(state.timerInterval) clearInterval(state.timerInterval); state.timerInterval = null; widgetData.running = false; if (widgetData.mode === 'countdown') { widgetData.time = widgetData.setTime; } else { widgetData.time = 0; widgetData.laps = []; } renderApp(); });
            document.getElementById('btn-timer-lap')?.addEventListener('click', () => { if (widgetData.mode === 'stopwatch' && widgetData.running) { widgetData.laps.push(widgetData.time); renderApp(); } });
            document.getElementById('btn-timer-mode-countdown')?.addEventListener('click', () => { if (widgetData.mode !== 'countdown') { widgetData.mode = 'countdown'; widgetData.time = widgetData.setTime; widgetData.running = false; if(state.timerInterval) clearInterval(state.timerInterval); state.timerInterval = null; renderApp(); } });
            document.getElementById('btn-timer-mode-stopwatch')?.addEventListener('click', () => { if (widgetData.mode !== 'stopwatch') { widgetData.mode = 'stopwatch'; widgetData.time = 0; widgetData.laps = []; widgetData.running = false; if(state.timerInterval) clearInterval(state.timerInterval); state.timerInterval = null; renderApp(); } });
            const handleTimeSet = () => { const minutes = parseInt(document.getElementById('timer-set-minutes').value, 10) || 0; const seconds = parseInt(document.getElementById('timer-set-seconds').value, 10) || 0; widgetData.setTime = (minutes * 60) + seconds; if (!widgetData.running) { widgetData.time = widgetData.setTime; renderApp(); } };
            document.getElementById('timer-set-minutes')?.addEventListener('input', handleTimeSet);
            document.getElementById('timer-set-seconds')?.addEventListener('input', handleTimeSet);
        }
        
        function handleQRCodeInput(e, widgetData) { widgetData.text = e.target.value; const qrContainer = document.getElementById('qrcode-container'); if (qrContainer) { if (e.target.value) { generateQRCode(qrContainer, e.target.value); } else { qrContainer.innerHTML = ''; } } }
        function handleVideoUrlInput(e, widgetData) { widgetData.url = e.target.value; renderApp(); }
        function handleVideoFileInput(e, widgetData) { const file = e.target.files[0]; if (file) { const url = URL.createObjectURL(file); widgetData.url = url; renderApp(); } }
        function handleImageUrlInput(e, widgetData) { widgetData.url = e.target.value; renderApp(); }

        // ===================================================================================
        // UTILITY FUNCTIONS
        // ===================================================================================
        
        function findCurrentWidget() {
            const currentView = state.views[state.currentViewIndex];
            if (!currentView) return null;
            if (currentView.type === 'presentation') {
                return currentView.deck[currentView.activeSlideIndex]?.widget;
            }
            return currentView;
        }

        function showModal(title, message, buttons) {
            const modalContainer = document.getElementById('modal-container');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            const buttonsContainer = document.getElementById('modal-buttons');
            buttonsContainer.innerHTML = '';
            buttons.forEach(buttonInfo => {
                const button = document.createElement('button');
                button.textContent = buttonInfo.text;
                button.className = `px-4 py-2 rounded-md transition-all ${buttonInfo.class}`;
                button.onclick = () => { if(buttonInfo.callback) buttonInfo.callback(); closeModal(); };
                buttonsContainer.appendChild(button);
            });
            modalContainer.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal-container').classList.add('hidden');
        }

        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function playTimerEndSound() {
            if (!state.audioContext) return;
            const oscillator = state.audioContext.createOscillator();
            const gainNode = state.audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(state.audioContext.destination);
            oscillator.type = 'square';
            oscillator.frequency.setValueAtTime(880, state.audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.3, state.audioContext.currentTime);
            oscillator.start();
            oscillator.stop(state.audioContext.currentTime + 0.2);
        }

        function getYoutubeEmbedUrl(url) {
            if (!url) return null;
            let videoId;
            try {
                const urlObj = new URL(url);
                if (urlObj.hostname.includes("youtube.com")) { videoId = urlObj.searchParams.get('v'); } 
                else if (urlObj.hostname.includes("youtu.be")) { videoId = urlObj.pathname.slice(1); }
                if (videoId) return `https://www.youtube.com/embed/${videoId}`;
                if (urlObj.pathname.includes('/embed/')) return url;
            } catch (e) { return null; }
            return null;
        }

        function generateQRCode(container, text) {
            container.innerHTML = '';
            try {
                new QRCode(container, { text: text, width: 200, height: 200, colorDark: "#0f0f2e", colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.H });
            } catch (e) {
                console.error("QR Code generation failed:", e);
                container.textContent = 'Error generating QR Code.';
            }
        }

        // ===================================================================================
        // APP START
        // ===================================================================================
        
        renderApp();

    </script>
</body>
</html>
